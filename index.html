<!DOCTYPE html>
<html lang="eng">

<head>
    <meta charset="utf-8" />
    <title>Autoglosser</title>

    <!-- import packages etc. -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css"
        type="text/css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"
        type="text/javascript"></script>


    <script type="text/javascript">
        function reformat(theString) {
            console.log("Start of reformat()")

            const theList = theString.split(',');
            var sentenceT = document.getElementById("workingSentence");
            const sentence = sentenceT.innerHTML.split(" ");
            sentence[sentence.length - 1] = sentence[sentence.length - 1].trim() //FIX THIS LINE FOR TRIMMING WHITESPACE AT END OF INPUT
            var sentenceT = document.getElementById("workingOrig");
            const sentenceO = sentenceT.innerHTML.split(" ");
            var sentenceT = document.getElementById("workingNormSpl");
            const sentenceNS = sentenceT.innerHTML.split(" ");
            var sentenceT = document.getElementById("workingGloss");
            const sentenceG = sentenceT.innerHTML.split(" ");
            var sentenceT = document.getElementById("workingLSpl");
            const sentenceLS = sentenceT.innerHTML.split(" ");
            var sentenceT = document.getElementById("workingLGloss");
            const sentenceLG = sentenceT.innerHTML.split(" ");

            console.log(sentenceG);

            console.log(theList);
            console.log(sentence);

            for (var row = 0; row < sentence.length; row++) {
                if (theList.includes("glossOf" + row)) {
                    console.log("theList includes \"glossOf" + row + "\"");
                    var newVal = document.getElementsByName(theList[theList.indexOf("glossOf" + row)]);
                    console.log("newVal: ");
                    console.log(newVal);
                    var i;
                    for (i = 0; i < newVal.length; i++) {
                        if (newVal[i].checked) {
                            sentence[row] = newVal[i].value;
                            sentenceNS[row] = sentenceNS[row].split("/")[i]
                            sentenceG[row] = sentenceG[row].split("/")[i]
                            sentenceLS[row] = sentenceLS[row].split("/")[i]
                            sentenceLG[row] = sentenceLG[row].split("/")[i]
                        }
                    }
                } else {
                    console.log("theList does not include \"glossOf" + row + "\"");
                }
            }
            console.log(sentence);
            var finalSentence = sentence.join(" ");
            var finalSentenceNS = sentenceNS.join(" ");
            var finalSentenceG = sentenceG.join(" ");
            var finalSentenceLS = sentenceLS.join(" ");
            var finalSentenceLG = sentenceLG.join(" ");
            console.log(finalSentence);
            console.log(finalSentenceLS)

            document.getElementById("workingSentence").innerHTML = finalSentence
            document.getElementById("workingNormSpl").innerHTML = finalSentenceNS
            document.getElementById("workingGloss").innerHTML = finalSentenceG
            document.getElementById("workingLSpl").innerHTML = finalSentenceLS
            document.getElementById("workingLGloss").innerHTML = finalSentenceLG

            for (var word = 0; word < sentence.length; word++) {

            }




            console.log("End of reformat()");




        }

        $(document).ready(function () {
            // when submit button is pressed on webpage...
            $("#submit").click(function () {
                var that = this;
                $("#results").text("");

                console.log($("#inputtextarea").val());

                // reorganize data that's in the text field into a list
                var lines = $("#inputtextarea").val().split("\n");
                var joined = lines
                    .filter((line) => line.trim() !== " ")
                    .join("");

                console.log(joined);
                // orgainize it into a dictionary...
                var data = { 'inputword': joined };
                // ...and send it to the python script
                var url = "cgi-bin/autogloss.py";

                console.log(data);

                // ajax is the communicator between the html and the python
                $.ajax({
                    // set variables
                    type: "GET",
                    url: url,
                    data: data,
                    dataType: "JSON",
                    // assuming the script executed sucessfully (see error block for else case)
                    success: function (jsonStr) {
                        // put python output in the console
                        console.log("[" + url + "]: " + JSON.stringify(jsonStr));
                        // if there was not ambiguity in the python output do a standard print out
                        if (jsonStr["ambiguity"] == "False") {
                            if (jsonStr.hasOwnProperty("inputword")) {
                                console.log(jsonStr["inputword"]);
                                $("<p><i>Original:</i></p>").appendTo($("#results"));
                                $("<p>&emsp;" + jsonStr["inputword"] + "</p> <br>").appendTo($("#results"));
                            }

                            if (jsonStr.hasOwnProperty("gloss")) {
                                console.log(jsonStr["gloss"]);
                                $("<p><i>Normalized Spelling + Gloss:</i></p>").appendTo($("#results"));
                                $("<p>&emsp;" + jsonStr["normSpl"] + "</p>").appendTo($("#results"));
                                $("<p>&emsp;" + jsonStr["gloss"] + "</p> <br>").appendTo($("#results"));
                            }

                            if (jsonStr.hasOwnProperty("latexGloss")) {
                                console.log(jsonStr["latexGloss"]);
                                $("<p><i>LaTeX Spelling + Gloss:</i></p>").appendTo($("#results"));
                                $("<p>&emsp;" + jsonStr["latexGloss"] + "</p>").appendTo($("#results"));
                                $("<p>&emsp;" + jsonStr["gloss"] + "</p> <br>").appendTo($("#results"));
                            }
                            // if there is ambiguity found...
                        } else {
                            $("#tableDiv").css("display", "block")
                            $("<p>~~~</p>").appendTo($("#results"));
                            $("<p>Ambiguity was found</p>").appendTo($("#results"));
                            $("<p>~~~</p><br>").appendTo($("#results"));
                            $("<p>Initial input and gloss with ambiguity:</p>").appendTo($("#results"));
                            $("<p style=\"padding-left:50px\">" + jsonStr["inputword"].join(" ") + "</p>").appendTo($("#results"));
                            $("<p style=\"padding-left:50px\" id=\"workingSentence\">" + jsonStr["gloss"].join(" ") + "</p>").appendTo($("#results"));
                            $("<br>").appendTo($("#results"));
                            $("<p><i>Original:</i></p>").appendTo($("#ambResults"));
                            $("<p id=\"workingOrig\" style=\"padding-left:50px\">" + jsonStr["inputword"].join(" ") + "</p>").appendTo($("#ambResults"));
                            $("<p><i>Normalized Spelling + Gloss:</i></p>").appendTo($("#ambResults"));
                            $("<p id=\"workingNormSpl\" style=\"padding-left:50px\">" + jsonStr["normSpl"].join(" ") + "</p>").appendTo($("#ambResults"));
                            $("<p id=\"workingGloss\" style=\"padding-left:50px\">" + jsonStr["gloss"].join(" ") + "</p>").appendTo($("#ambResults"));
                            $("<p><i>LaTeX Spelling + Gloss:</i></p>").appendTo($("#ambResults"));
                            $("<p id=\"workingLSpl\" style=\"padding-left:50px\">" + jsonStr["latexGloss"].join(" ") + "</p>").appendTo($("#ambResults"));
                            $("<p id=\"workingLGloss\" style=\"padding-left:50px\">" + jsonStr["gloss"].join(" ") + "</p>").appendTo($("#ambResults"));

                            // append to the table
                            $("<tr>").appendTo($("#table"))
                            const theSet = new Set();
                            for (var num in jsonStr["inputword"]) {
                                if (jsonStr["gloss"][num].includes("/")) {
                                    $("<p>" + jsonStr["inputword"][num] + "</p>").appendTo($("#table"));
                                    var startidx = 0;
                                    for (var ltr in jsonStr["gloss"][num]) {
                                        console.log(jsonStr["gloss"][num]);
                                        if (jsonStr["gloss"][num][ltr] == "/") {
                                            $("<input type=\"radio\" name=\"glossOf" + num + "\" value =" + jsonStr["gloss"][num].substring(startidx, ltr) + ">" + jsonStr["gloss"][num].substring(startidx, ltr) + "&emsp;</input>").appendTo($("#table"));
                                            startidx = ltr;
                                            startidx++;
                                            theSet.add("glossOf" + num);
                                        } else if (ltr == jsonStr["gloss"][num].length - 1 && jsonStr["gloss"][num].includes("/")) {
                                            $("<input type=\"radio\" name=\"glossOf" + num + "\" value=" + jsonStr["gloss"][num].substring(startidx, ltr + 1) + ">" + jsonStr["gloss"][num].substring(startidx, ltr + 1) + "&emsp;</input>").appendTo($("#table"));
                                            startidx = ltr;
                                            startidx++;
                                            theSet.add("glossOf" + num);
                                        }
                                    }
                                }


                            }
                            const theList = Array.from(theSet);
                            console.log(theList);
                            $("</tr>").appendTo($("#table"));
                            $("<button id=\"submitAmb\" style=\"cursor: pointer\" onclick=\"reformat('" + theList + "') \">submit</button>").appendTo($("#tableDiv"));
                        }
                    },
                    // if python did not execute sucessfully...
                    error: function (
                        XMLHttpRequest,
                        textStatus,
                        errorThrown,
                    ) {
                        // ... report these errors in the console
                        console.log("[" + url + "]: Status: " + textStatus);
                        console.log("[" + url + "]: Error: " + errorThrown);
                        console.log("[" + url + "]: XMLHttpRequest: " + XMLHttpRequest);
                        $("#results").text("");
                        $("<p>Something went wrong. Try...</p><br><p>&emsp;Checking the formatting of the input (minimize extra characters and whitespace).</p><p>&emsp;Opening the console and looking at debug statements.</p><p>&emsp;Be sure to reload the page between queries.</p><p>&emsp;Make sure no file names/directories were changed since downloading repo.</p>").appendTo($("#results"));
                    },
                });
            });
        });
    </script>

</head>

<body>
    <div id="userinputform">
        <form>
            <textarea rows="5" cols="60" placeholder="Input text here." id="inputtextarea"></textarea>
            <br />
            <input type="button" value="submit" id="submit" style="cursor: pointer" />
        </form>
    </div>

    <div id="results"></div>

    <div id="tableDiv" class="table_container" style="display:None">
        <table style="width:fit;color:black;" border="1" id="table">
        </table>
        <br>
    </div>

    <div id="ambResults"></div>


</body>

</html>